#!/usr/bin/env bash
cd ../
source ../../.env

STRIP=$1

if [ ! -z $STRIP ] && [ $STRIP = 'dev' ]; then
    # database dump for development without customer or order data
    TIMESTAMP=$(date +%Y-%m-%d-%H.%M.%S)
    docker-compose -p $PROJECT_NAME exec -T -u root db mysqldump --single-transaction --quick --no-data -umagento -pmagento magento admin_assert admin_role admin_rule admin_user adminnotification_inbox catalogsearch_fulltext catalogsearch_query catalogsearch_result core_session customer_address_entity customer_address_entity_datetime customer_address_entity_decimal customer_address_entity_int customer_address_entity_text customer_address_entity_varchar customer_entity customer_entity_datetime customer_entity_decimal customer_entity_int customer_entity_text customer_entity_varchar dataflow_batch dataflow_batch_export dataflow_batch_import dataflow_import_data dataflow_session importexport_importdata log_url log_url_info log_visitor log_visitor_info log_visitor_online newsletter_problem newsletter_queue newsletter_queue_link newsletter_queue_store_link newsletter_subscriber newsletter_template report_compared_product_index report_event report_viewed_product_aggregated_daily report_viewed_product_aggregated_monthly report_viewed_product_aggregated_yearly report_viewed_product_index sales_bestsellers_aggregated_daily sales_bestsellers_aggregated_monthly sales_bestsellers_aggregated_yearly sales_flat_creditmemo sales_flat_creditmemo_comment sales_flat_creditmemo_grid sales_flat_creditmemo_item sales_flat_invoice sales_flat_invoice_comment sales_flat_invoice_grid sales_flat_invoice_item sales_flat_order sales_flat_order_address sales_flat_order_grid sales_flat_order_item sales_flat_order_payment sales_flat_order_status_history sales_flat_quote sales_flat_quote_address sales_flat_quote_address_item sales_flat_quote_item sales_flat_quote_item_option sales_flat_quote_payment sales_flat_quote_shipping_rate sales_flat_shipment sales_flat_shipment_comment sales_flat_shipment_grid sales_flat_shipment_item sales_flat_shipment_track sales_order_aggregated_created sales_order_aggregated_updated sales_order_tax sales_order_tax_item sales_payment_transaction sales_recurring_profile sales_recurring_profile_order sales_refunded_aggregated sales_refunded_aggregated_order salesrule_coupon_usage salesrule_customer wishlist wishlist_item wishlist_item_option | LANG=C LC_CTYPE=C LC_ALL=C sed -e 's/DEFINER[ ]*=[ ]*[^*]*\*/\*/' > mysqldump/$TIMESTAMP.sql
    docker-compose -p $PROJECT_NAME exec -T -u root db mysqldump --single-transaction --quick -umagento -pmagento magento --ignore-table=magento.admin_assert --ignore-table=magento.admin_role --ignore-table=magento.admin_rule --ignore-table=magento.admin_user --ignore-table=magento.adminnotification_inbox --ignore-table=magento.catalogsearch_fulltext --ignore-table=magento.catalogsearch_query --ignore-table=magento.catalogsearch_result --ignore-table=magento.core_session --ignore-table=magento.customer_address_entity --ignore-table=magento.customer_address_entity_datetime --ignore-table=magento.customer_address_entity_decimal --ignore-table=magento.customer_address_entity_int --ignore-table=magento.customer_address_entity_text --ignore-table=magento.customer_address_entity_varchar --ignore-table=magento.customer_entity --ignore-table=magento.customer_entity_datetime --ignore-table=magento.customer_entity_decimal --ignore-table=magento.customer_entity_int --ignore-table=magento.customer_entity_text --ignore-table=magento.customer_entity_varchar --ignore-table=magento.dataflow_batch --ignore-table=magento.dataflow_batch_export --ignore-table=magento.dataflow_batch_import --ignore-table=magento.dataflow_import_data --ignore-table=magento.dataflow_session --ignore-table=magento.importexport_importdata --ignore-table=magento.log_url --ignore-table=magento.log_url_info --ignore-table=magento.log_visitor --ignore-table=magento.log_visitor_info --ignore-table=magento.log_visitor_online --ignore-table=magento.newsletter_problem --ignore-table=magento.newsletter_queue --ignore-table=magento.newsletter_queue_link --ignore-table=magento.newsletter_queue_store_link --ignore-table=magento.newsletter_subscriber --ignore-table=magento.newsletter_template --ignore-table=magento.report_compared_product_index --ignore-table=magento.report_event --ignore-table=magento.report_viewed_product_aggregated_daily --ignore-table=magento.report_viewed_product_aggregated_monthly --ignore-table=magento.report_viewed_product_aggregated_yearly --ignore-table=magento.report_viewed_product_index --ignore-table=magento.sales_bestsellers_aggregated_daily --ignore-table=magento.sales_bestsellers_aggregated_monthly --ignore-table=magento.sales_bestsellers_aggregated_yearly --ignore-table=magento.sales_flat_creditmemo --ignore-table=magento.sales_flat_creditmemo_comment --ignore-table=magento.sales_flat_creditmemo_grid --ignore-table=magento.sales_flat_creditmemo_item --ignore-table=magento.sales_flat_invoice --ignore-table=magento.sales_flat_invoice_comment --ignore-table=magento.sales_flat_invoice_grid --ignore-table=magento.sales_flat_invoice_item --ignore-table=magento.sales_flat_order --ignore-table=magento.sales_flat_order_address --ignore-table=magento.sales_flat_order_grid --ignore-table=magento.sales_flat_order_item --ignore-table=magento.sales_flat_order_payment --ignore-table=magento.sales_flat_order_status_history --ignore-table=magento.sales_flat_quote --ignore-table=magento.sales_flat_quote_address --ignore-table=magento.sales_flat_quote_address_item --ignore-table=magento.sales_flat_quote_item --ignore-table=magento.sales_flat_quote_item_option --ignore-table=magento.sales_flat_quote_payment --ignore-table=magento.sales_flat_quote_shipping_rate --ignore-table=magento.sales_flat_shipment --ignore-table=magento.sales_flat_shipment_comment --ignore-table=magento.sales_flat_shipment_grid --ignore-table=magento.sales_flat_shipment_item --ignore-table=magento.sales_flat_shipment_track --ignore-table=magento.sales_order_aggregated_created --ignore-table=magento.sales_order_aggregated_updated --ignore-table=magento.sales_order_tax --ignore-table=magento.sales_order_tax_item --ignore-table=magento.sales_payment_transaction --ignore-table=magento.sales_recurring_profile --ignore-table=magento.sales_recurring_profile_order --ignore-table=magento.sales_refunded_aggregated --ignore-table=magento.sales_refunded_aggregated_order --ignore-table=magento.salesrule_coupon_usage --ignore-table=magento.salesrule_customer --ignore-table=magento.wishlist --ignore-table=magento.wishlist_item --ignore-table=magento.wishlist_item_option  | LANG=C LC_CTYPE=C LC_ALL=C sed -e 's/DEFINER[ ]*=[ ]*[^*]*\*/\*/' >> mysqldump/$TIMESTAMP.sql
    gzip mysqldump/$TIMESTAMP.sql
else
    docker-compose -p $PROJECT_NAME exec -T -u root db mysqldump -umagento -pmagento magento | gzip -c > mysqldump/$(date +%Y-%m-%d-%H.%M.%S).sql.gz
fi
